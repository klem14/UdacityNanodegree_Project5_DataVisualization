<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="js/d3.slider.js"></script>
  <link rel="stylesheet" href="css/d3.slider.css" /> 
  <style>
	circle {
	stroke: black;
	stroke-width: 0.7;
	opacity: 0.7;
	}

	h2 {
	text-align: left;
	margin-left: 200px;
	color: black;
	}

	
	.q2-4{fill:rgb(215,25,28)}
	.q1-4{fill:rgb(253,174,97)}
	.q0-4{fill:rgb(166,217,106)}

	div#slider { width: 1195px; left:5px; }
	
	path.domain{ display: none; }
	.tick text { font-family: sans-serif;
				font-size: 12px; }
			

    </style>
  <script type="text/javascript">
    var formatPercent = d3.format(".0%"),
		formatNumber = d3.format(",0f");
		
	var colors = d3.scale.threshold()
						 .domain([0.15,0.25])
						 .range(["q0-4","q1-4","q2-4"]);
						 
	function add_legeng(tag){
		var x = d3.scale.linear()
						.domain([0.05, 0.4])
						.range([0, 180]);
						
		
		var xAxis = d3.svg.axis()
			.scale(x)
			.orient('bottom')
			.tickSize(13)
			.tickValues(colors.domain())
			.tickFormat(function(d) { return d === .25 ? formatPercent(d) : formatNumber(100 * d); });
			
		/* add the color scale legend */
		tag.selectAll('rect')
			.data(colors.range().map(function(color) {
										var d = colors.invertExtent(color);
										if (d[0] == null) d[0] = x.domain()[0];
										if (d[1] == null) d[1] = x.domain()[1];
										return d;}))
									.enter().append('rect')
									.attr('height', 8)
									.attr('x', function(d) { return x(d[0]); })
									.attr('width', function(d) { return x(d[1]) - x(d[0]); })
									.attr('class', function(d) { return colors(d[0]); });
									
		tag.call(xAxis).append('text')
						.attr('class', 'caption')
						.attr('y', -6)
						.text("Percentage of flights delayed or cancelled")
						.style('font-family','sans-serif')
						.style('font-size','14px');
		
		/* add the circle diameter legend */
		var radius = d3.scale.sqrt()
				   .domain([0, 500000])
				   .range([0, 30]);
	
		tag.selectAll('circle')
				.data([400000,220000,100000,25000])
				.enter()
				.append('circle')
				.attr('cx',25)
				.attr('cy',55) 
				.attr('r', function(d){ return radius(d);})
				.style('fill','white')
				.style('stroke','black')

		tag.append('text')
			.attr('x',60)
			.attr('y',60)
			.style('font-size','14px')
			.style('font-family','sans-serif')
			.text('Nb of flights landing on');


	}
	
	function draw(geo_data) {

        var margin = 75,
            width = 1200 - margin,
            height = 700 - margin;

        d3.select('body')
          .append('h2')
          .text("Percentage of Delays and Cancellations recorded in the US landing airports");

        var svg = d3.select('body')
            .append('svg')
            .attr('width', width + margin)
            .attr('height', height + margin)
			.style('background','#6699CC')
            .append('g')
            .attr('class', 'map');
		
		/* draw the US map */
        var projection = d3.geo.albersUsa()
							   .scale(1450)
                               .translate([width / 1.8, height / 1.8]);

        var path = d3.geo.path().projection(projection);

        var map = svg.selectAll('path')
                     .data(geo_data.features)
                     .enter()
                     .append('path')
                     .attr('d', path)
                     .style('fill', 'white')
                     .style('stroke', 'black')
                     .style('stroke-width', 0.5);
		
		/* place the legend */		
		svg = d3.select('svg').append('g')
							  .attr('class', 'legend')
							  .attr('transform', "translate(" + width * 3 / 4 + "," + 30 + ")");
		
		add_legeng(svg);
		
		function load_data(data) {
			
			function agg_year(leaves) {
                return {
				  'flights': d3.sum(leaves, function(d) { return d['Flights_Count']; }),
                  'delays' : d3.sum(leaves, function(d) { return d['ArrDelay_Sum']; }) / d3.sum(leaves, function(d) { return d['Flights_Count']; })
                };
            };

			/* aggregate the data per year and destination airports */
            var nested = d3.nest()
                           .key(function(d) { return d['Year']; })
						   .key(function(d) { return d['Dest']; })
                           .rollup(agg_year)
                           .entries(data);
			
			function plot_airport(points) {
				var airports = points.map(function(d) {
						return {
							'code': d.iata,
							'name': d.airport+", "+d.state,
							'coords': projection([+d.long,+d.lat])
						};
					});
					
				svg = d3.select('svg')
					.append('g')
					.attr('class', 'airport');
				
				var flightsNb_max = 500000;
				
				function update(year) {
					/* fitler the dtaset to exclude the year, so it remains grouped by destination airports only */
					var year_data = nested.filter(function(d) { return d['key'] == year;})[0].values
										  .sort(function(a, b) { return b.values['flights'] - a.values['flights'];});
					
					var radius = d3.scale.sqrt()
								   .domain([0, flightsNb_max])
								   .range([0, 30]);
					
					/* fro each airport, bring its coordinated (long,lat) from airports dataset*/
					year_data.forEach(function(d){
						var result = airports.filter(function(airport){
							return d.key === airport.code;
						});
						/* if coordinates returned by the mapper are null because outside of the US (e.g Guam or Puerto Rico airports), replace by null */
						d.coords = (result[0] !== undefined) ? result[0].coords : null;
						d.name = (result[0] !== undefined) ? result[0].name : null;
					});					
								  
					d3.select('h2')
					  .text("Percentage of Delays and Cancellations recorded in the US landing airports: " + year);

					var circles = svg.selectAll('circle')
									.data(year_data.filter(function(d){return d.coords != null;}),function(d){ return d.key;});
				
					circles.exit().remove();
					circles.enter()
						.append('circle')
						
					circles.attr('cx', function(d){ return d.coords[0]; })
						.attr('cy', function(d){ return d.coords[1]; })
						/* adjust diameter depending on the nmber of flights */
						.attr('r', function(d) {
							return radius(d.values['flights']);
						 })
						 /*set up the color from the percentage of delays and cancellations */
						.attr('class', function(d) {
							return colors(d.values['delays']);})
											/* add tooltip */
						.append('title')	
						.text(function(d) { return d.name+"\n Number of flights: "+formatNumber(d.values['flights'])+"\n% delays and cancellations: "+formatPercent(d.values['delays']); })
						.attr('fill', 'black')
						.transition()
						.duration(500);
				}
				
				var year_start = d3.min(nested, function(d) { return +d['key']; });
				var year_end = d3.max(nested, function(d) { return +d['key']; });
				
				var years = [];
				
				/* load the different years conatined in the dataset */
				for(var i = year_start; i <= year_end; i += 1) {
					years.push(i);
				};

				var year_idx = 0;
				
				/* iterate through years */
				var year_interval = setInterval(function() {
					update(years[year_idx]);

					year_idx++;

					if(year_idx >= years.length) {
						/* grant control of the years' selection to user */
						clearInterval(year_interval);
							
						var buttons = d3.select('body').append('div')
													.attr('id', 'slider')
						
						/* slider is defined/programmed as an external library (see resources) */							
						buttons.call(d3.slider()
										.axis(true)
										.min(year_start)
										.max(year_end)
										.step(1)
										.value(year_end));
						
						var yearSaved = year_end;
						
						/* when moving the slider's button */
						buttons.select('a').on('mouseup', function() {
							var currentYear = Math.round(this.name);
							if (currentYear!= +yearSaved){
								update(+currentYear);
								yearSaved = currentYear;
							}
						});
						
						/* when clicking on the scale */
						buttons.select('a').on('mouseenter', function() {
							var currentYear = Math.round(this.name);
							if (currentYear!= +yearSaved){
								update(+currentYear);
								yearSaved = currentYear;
							}
						});
					}
				}, 1000);
				
			}
			/* load airports information */
			d3.csv("data/airports.csv",plot_airport);
		};
		/* load the flight data froim the RITA*/
		d3.csv("data/RITA.csv",load_data);
	};
   </script>
</head>
<body>
  <script type="text/javascript">
  /* load the US (border + states) TopoJson data */
  d3.json("data/US_states.json", draw);
  
  </script>
</body>
</html>
