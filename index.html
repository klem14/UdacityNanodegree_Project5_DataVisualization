<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="js/d3.slider.js"></script>
  <link rel="stylesheet" href="css/d3.slider.css" /> 
  <style>
	circle {
	stroke: black;
	stroke-width: 0.7;
	opacity: 0.7;
	}

	h2 {
	text-align: left;
	margin-left: 500px;
	color: black;
	}

	circle.q3-4{fill:rgb(215,25,28)} 
	circle.q2-4{fill:rgb(253,174,97)}
	circle.q1-4{fill:rgb(255,255,191)}
	circle.q0-4{fill:rgb(166,217,106)}

	div#slider { width: 1200px; }

    </style>
  <script type="text/javascript">
	function draw(geo_data) {
      
      /*
        D3.js setup code
      */
		
		 "use strict";
        var margin = 75,
            width = 1200 - margin,
            height = 700 - margin;

        d3.select("body")
          .append("h2")
          .text("Air Flights ");

        var svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin)
            .attr("height", height + margin)
			.style('background','#6699CC')
            .append('g')
            .attr('class', 'map');

        var projection = d3.geo.albersUsa()
							   .scale(1450)
                               .translate([width / 1.8, height / 1.8]);

        var path = d3.geo.path().projection(projection);

        var map = svg.selectAll('path')
                     .data(geo_data.features)
                     .enter()
                     .append('path')
                     .attr('d', path)
                     .style('fill', 'white')
                     .style('stroke', 'black')
                     .style('stroke-width', 0.5);
		
		function load_data(data) {
			
			function agg_year(leaves) {
                return {
				  'flights': d3.sum(leaves, function(d) { return d['Flights_Count']; }),
                  'delays' : d3.sum(leaves, function(d) { return d['ArrDelay_Sum']; }) / d3.sum(leaves, function(d) { return d['Flights_Count']; })
                };
            };

            var nested = d3.nest()
                           .key(function(d) { return d['Year']; })
						   .key(function(d) { return d['Dest']; })
                           .rollup(agg_year)
                           .entries(data);
			
			function plot_airport(points) {
				var airports = points.map(function(d) {
						return {
							'code': d.iata,
							'name': d.airport+", "+d.state,
							'coords': projection([+d.long,+d.lat])
						};
					});
					
				svg = d3.select('svg')
					.append('g')
					.attr("class", "airport");
				
				var flightsNb_max = 500000;
				
				function update(year) {

					var year_data = nested.filter(function(d) { return d['key'] == year;})[0].values
										  .sort(function(a, b) { return b.values['flights'] - a.values['flights'];});
					
					var radius = d3.scale.sqrt()
								   .domain([0, flightsNb_max])
								   .range([0, 30]);
					
					year_data.forEach(function(d){
						var result = airports.filter(function(airport){
							return d.key === airport.code;
						});
						d.coords = (result[0] !== undefined) ? result[0].coords : null;
						d.name = (result[0] !== undefined) ? result[0].name : null;
					});					
					
					var colors = d3.scale.threshold()
								  .domain([0.15,0.2,0.25])
								  .range(['q0-4','q1-4','q2-4','q3-4']);
								  
					d3.select("h2")
					  .text("Air traffic " + year);

					var circles = svg.selectAll('circle')
									.data(year_data.filter(function(d){return d.coords != null;}),function(d){ return d.key;});
				
					circles.exit().remove();
					circles.enter()
						.append('circle')
						
					circles.attr('cx', function(d){ return d.coords[0]; })
						.attr('cy', function(d){ return d.coords[1]; })
						.attr('r', function(d) {
							return radius(d.values['flights']);
						 })
						.attr('class', function(d) {
							return colors(d.values['delays']);})
						.append('title')
						.text(function(d) { return d.name; })
						.attr('fill', 'black')
						.transition()
						.duration(500);
				}
				
				var year_start = d3.min(nested, function(d) { return +d['key']; });
				var year_end = d3.max(nested, function(d) { return +d['key']; });
				
				var years = [];

				for(var i = year_start; i <= year_end; i += 1) {
					years.push(i);
				};

				var year_idx = 0;
				
				var year_interval = setInterval(function() {
					update(years[year_idx]);

					year_idx++;

					if(year_idx >= years.length) {
						clearInterval(year_interval);
												
						var buttons = d3.select('body').append('div')
													.attr('id', 'slider')
													
						buttons.call(d3.slider()
										.axis(true)
										.min(year_start)
										.max(year_end)
										.step(1)
										.value(year_end));
						
						var yearSaved = year_end;
						
						//moving the button
						buttons.select('a').on('mouseup', function() {
							var currentYear = Math.round(this.name);
							if (currentYear!= +yearSaved){
								update(+currentYear);
								yearSaved = currentYear;
							}
						});
						//clicking on the scale
						buttons.select('a').on('mouseenter', function() {
							var currentYear = Math.round(this.name);
							if (currentYear!= +yearSaved){
								update(+currentYear);
								yearSaved = currentYear;
							}
						});
					}
				}, 1000);
				
			}
			
			d3.csv("data/airports.csv",plot_airport);
		};
		
		d3.csv("data/RITA.csv",load_data);
	};
   </script>
</head>
<body>
  <script type="text/javascript">

  d3.json("data/US_states.json", draw);
  
  </script>
</body>
</html>
